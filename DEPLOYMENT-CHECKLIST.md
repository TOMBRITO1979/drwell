# DrWell - Checklist de Deploy

Use este checklist para garantir que tudo est√° configurado corretamente.

---

## üìã Pr√©-Deploy

### Infraestrutura
- [ ] Docker Swarm inicializado
- [ ] Portainer instalado e acess√≠vel
- [ ] Rede `network-public` criada
- [ ] Redis rodando como `redis_redis`
- [ ] Traefik configurado com Let's Encrypt
- [ ] Dom√≠nios apontando para o servidor (DNS)

### C√≥digos e Reposit√≥rios
- [ ] C√≥digo commitado no GitHub
- [ ] Reposit√≥rio: https://github.com/TOMBRITO1979/drwell
- [ ] Branch `main` ou `master` atualizada

---

## üîê Secrets e Senhas

### GitHub Secrets (para CI/CD)
- [ ] `DOCKER_USERNAME` = `tomautomations`
- [ ] `DOCKER_TOKEN` = [token fornecido]

### Portainer Secrets
- [ ] Secret `postgres_password` criado (senha forte!)
- [ ] Secret `secret_key` criado (chave aleat√≥ria!)

### Gerar Senhas
```bash
# Secret Key
python3 -c "import secrets; print(secrets.token_urlsafe(50))"

# Postgres Password
openssl rand -base64 32
```

---

## üê≥ Docker Image

### Op√ß√£o A: Build Local
- [ ] Executar `build-and-push.sh` (Linux/Mac)
- [ ] Ou `build-and-push.bat` (Windows)
- [ ] Login no DockerHub bem-sucedido
- [ ] Imagem enviada: `tomautomations/drwell:latest`

### Op√ß√£o B: CI/CD GitHub Actions
- [ ] Secrets configurados no GitHub
- [ ] Push para `main`/`master` realizado
- [ ] GitHub Actions executado com sucesso
- [ ] Imagem dispon√≠vel no DockerHub

### Verificar Imagem
```bash
docker pull tomautomations/drwell:latest
docker run --rm tomautomations/drwell:latest python -c "import app; print('OK')"
```

---

## ‚öôÔ∏è Configura√ß√£o da Stack

### Ajustar docker-stack.yml

#### 1. Senha do PostgreSQL
- [ ] Substituir `POSTGRES_PASSWORD_PLACEHOLDER` nos servi√ßos:
  - `api`
  - `celery_worker`
  - `celery_beat`

#### 2. Dom√≠nios
- [ ] API: `Host(\`seu-dominio.com\`)`
- [ ] Flower: `Host(\`flower.seu-dominio.com\`)`

#### 3. Labels Traefik
- [ ] `certresolver=letsencrypt` configurado
- [ ] Entrypoint `websecure` (HTTPS)

#### 4. Recursos
- [ ] Replicas configuradas (api: 2, workers: 2)
- [ ] Limites de CPU/Memory apropriados

---

## üöÄ Deploy

### No Portainer
- [ ] Stacks ‚Üí Add stack
- [ ] Nome: `drwell`
- [ ] Web editor com `docker-stack.yml` ajustado
- [ ] Deploy the stack
- [ ] Aguardar ~30-60 segundos

### Verificar Deploy
```bash
# Ver servi√ßos
docker service ls | grep drwell

# Deve mostrar:
# - drwell_postgres (1/1)
# - drwell_api (2/2)
# - drwell_celery_worker (2/2)
# - drwell_celery_beat (1/1)
# - drwell_flower (1/1)
```

---

## üíæ Banco de Dados

### Executar Migrations

#### Via Portainer:
- [ ] Swarm ‚Üí Services ‚Üí `drwell_api`
- [ ] Containers ‚Üí Selecionar container
- [ ] Console ‚Üí Connect
- [ ] Executar:
  ```bash
  alembic revision --autogenerate -m "Initial migration"
  alembic upgrade head
  ```

#### Via SSH:
```bash
docker exec -it $(docker ps -q -f name=drwell_api | head -1) bash
alembic revision --autogenerate -m "Initial"
alembic upgrade head
exit
```

### Verificar Tabelas
- [ ] Conectar ao PostgreSQL
- [ ] Verificar se tabelas foram criadas
  ```bash
  docker exec -it $(docker ps -q -f name=drwell_postgres) psql -U drwell -d drwell_db -c "\dt"
  ```

---

## ‚úÖ Testes de Verifica√ß√£o

### Health Check
```bash
curl https://seu-dominio.com/health
# Esperado: {"status": "healthy"}
```
- [ ] Health check responde OK

### API Root
```bash
curl https://seu-dominio.com/
```
- [ ] Retorna informa√ß√µes da API

### Documenta√ß√£o
- [ ] https://seu-dominio.com/docs (Swagger UI)
- [ ] https://seu-dominio.com/redoc (ReDoc)

### Flower (Monitor Celery)
- [ ] https://flower.seu-dominio.com
- [ ] Mostra workers ativos

### Logs
```bash
docker service logs -f drwell_api
docker service logs drwell_celery_worker
docker service logs drwell_postgres
```
- [ ] Sem erros cr√≠ticos nos logs

### SSL/TLS
- [ ] HTTPS funcionando (Let's Encrypt)
- [ ] Certificado v√°lido
- [ ] Sem avisos de seguran√ßa

---

## üîß P√≥s-Deploy

### Monitoramento
- [ ] Flower acess√≠vel e mostrando workers
- [ ] Logs sendo gerados corretamente
- [ ] M√©tricas de recursos OK (CPU, RAM)

### Seguran√ßa
- [ ] Flower protegido (Basic Auth recomendado)
- [ ] Rate limiting configurado (opcional)
- [ ] Firewall configurado
- [ ] Apenas portas necess√°rias expostas

### Backup
- [ ] Configurar backup autom√°tico do PostgreSQL
- [ ] Testar restaura√ß√£o de backup
- [ ] Definir pol√≠tica de reten√ß√£o

### Escala
- [ ] Escalar API se necess√°rio: `docker service scale drwell_api=3`
- [ ] Escalar workers se necess√°rio: `docker service scale drwell_celery_worker=4`

---

## üìä Testes Funcionais

### Criar Primeiro Usu√°rio
- [ ] POST /api/v1/auth/register
- [ ] Verificar cria√ß√£o no banco

### Criar Escrit√≥rio
- [ ] POST /api/v1/law-firms
- [ ] Verificar dados salvos

### Criar Processo
- [ ] POST /api/v1/processes
- [ ] Verificar se Celery processa sync

### Testar Sync DataJud
- [ ] POST /api/v1/processes/{id}/sync
- [ ] Verificar logs do Celery Worker
- [ ] Verificar movimenta√ß√µes salvas

---

## üéØ Otimiza√ß√µes (Opcional)

### Performance
- [ ] Configurar cache Redis para queries
- [ ] Otimizar √≠ndices do PostgreSQL
- [ ] Configurar connection pooling

### Alta Disponibilidade
- [ ] M√∫ltiplos n√≥s no Swarm
- [ ] PostgreSQL com replica√ß√£o
- [ ] Redis Sentinel/Cluster

### Monitoramento Avan√ßado
- [ ] Prometheus + Grafana
- [ ] Sentry para errors
- [ ] APM (Application Performance Monitoring)

---

## üìù Documenta√ß√£o

- [ ] Atualizar README com URLs de produ√ß√£o
- [ ] Documentar APIs personalizadas
- [ ] Criar guia para usu√°rios finais
- [ ] Documentar procedimentos de backup/restore

---

## üÜò Troubleshooting

Se algo der errado:

1. **Verificar logs**:
   ```bash
   docker service logs -f drwell_api
   ```

2. **Verificar status**:
   ```bash
   docker service ps drwell_api
   ```

3. **Reiniciar servi√ßo**:
   ```bash
   docker service update --force drwell_api
   ```

4. **Rollback se necess√°rio**:
   ```bash
   docker service rollback drwell_api
   ```

---

## üéâ Deploy Completo!

Quando todos os itens estiverem marcados:

‚úÖ **Parab√©ns! Seu DrWell est√° no ar!**

Acesse:
- **API**: https://seu-dominio.com
- **Docs**: https://seu-dominio.com/docs
- **Flower**: https://flower.seu-dominio.com

---

## üìû Suporte

Problemas? Consulte:
- `DEPLOY.md` - Guia completo de deploy
- `PORTAINER-QUICKSTART.md` - Guia r√°pido
- GitHub Issues: https://github.com/TOMBRITO1979/drwell/issues
